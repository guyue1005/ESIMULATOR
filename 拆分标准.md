# DFG模块拆分停止标准

## 1. 拆分目标与方向

### 1.1 主要目标
- **线性化程度优化**: 最大化线性部分的比例，最小化非线性部分的复杂度
- **模块复杂度控制**: 控制单个模块的操作符数量、位宽等复杂度指标
- **依赖关系优化**: 减少模块间的循环依赖，提高并行性
- **性能影响评估**: 确保拆分后不显著影响关键路径延迟

### 1.2 量化指标定义
- **线性化程度阈值**: 目标线性化比例 ≥ 70%
- **最大复杂度阈值**: 单个模块操作符数量 ≤ 50个
- **位宽复杂度阈值**: 最大位宽 ≤ 64位
- **依赖深度阈值**: 最大依赖深度 ≤ 5层

## 2. 拆分评估框架

### 2.1 评估函数
```
Cost = α × Area + β × Delay + γ × Error + δ × Complexity
```

其中：
- **Area**: 面积估算 = 线性部分面积 + 非线性部分面积
- **Delay**: 关键路径延迟变化
- **Error**: 与原始函数的逼近误差
- **Complexity**: 模块复杂度评分

### 2.2 权重系数（可调整）
- α = 0.3 (面积权重)
- β = 0.3 (延迟权重) 
- γ = 0.2 (误差权重)
- δ = 0.2 (复杂度权重)

### 2.3 停止条件
1. **Cost函数收敛**: 连续3次迭代Cost变化 < 5%
2. **线性化达标**: 线性化程度 ≥ 70%
3. **复杂度达标**: 所有模块复杂度 ≤ 阈值
4. **最大迭代次数**: 达到预设的最大迭代次数（默认20次）

## 3. 算法流程

### 3.1 初始化阶段
1. 构建DFG数据流图
2. 标记线性/非线性操作节点
3. 计算初始复杂度指标
4. 设置拆分参数和阈值

### 3.2 迭代拆分阶段
1. **线性区域识别**: 从线性节点反向遍历，标记线性区域
2. **非线性区域分析**: 分析剩余非线性区域的复杂度
3. **拆分点选择**: 基于Cost函数选择最优拆分点
4. **模块提取**: 提取线性模块，更新DFG结构
5. **评估优化**: 计算新的Cost值，判断是否继续拆分

### 3.3 停止判断
1. 检查所有停止条件
2. 生成最终拆分方案
3. 输出拆分报告和性能分析

## 4. 复杂度评估标准

### 4.1 操作符复杂度权重
- 基本算术运算 (+, -, <<, >>): 权重 = 1
- 逻辑运算 (&, |, ^, ~): 权重 = 2  
- 乘除运算 (*, /, %): 权重 = 5
- 比较运算 (==, !=, <, >): 权重 = 1
- 条件分支 (if-else): 权重 = 3

### 4.2 位宽复杂度
- 8位及以下: 复杂度系数 = 1.0
- 16位: 复杂度系数 = 1.5
- 32位: 复杂度系数 = 2.0
- 64位及以上: 复杂度系数 = 3.0

### 4.3 依赖关系复杂度
- 无依赖: 复杂度系数 = 1.0
- 单层依赖: 复杂度系数 = 1.2
- 多层依赖: 复杂度系数 = 1.5
- 循环依赖: 复杂度系数 = 2.0

## 5. 性能影响评估

### 5.1 关键路径分析
- 识别最长计算路径
- 评估拆分对路径长度的影响
- 计算延迟变化百分比

### 5.2 面积估算
- 线性模块: 基于操作符数量和位宽估算
- 非线性模块: 考虑复杂度加权的面积估算
- 总体面积 = 各模块面积之和

### 5.3 误差分析
- 使用MSE（均方误差）评估逼近精度
- 计算最大绝对误差
- 评估误差对功能正确性的影响

## 6. 配置参数

### 6.1 阈值参数
```python
SPLIT_CONFIG = {
    'linearity_threshold': 0.7,      # 线性化程度阈值
    'max_complexity': 50,            # 最大操作符数量
    'max_bitwidth': 64,              # 最大位宽
    'max_dependency_depth': 5,       # 最大依赖深度
    'max_iterations': 20,            # 最大迭代次数
    'cost_convergence_threshold': 0.05,  # Cost收敛阈值
    'weights': {                     # 权重系数
        'area': 0.3,
        'delay': 0.3, 
        'error': 0.2,
        'complexity': 0.2
    }
}
```

### 6.2 操作符权重配置
```python
OPERATOR_WEIGHTS = {
    'Plus': 1, 'Minus': 1, 'UnaryMinus': 1,
    'And': 2, 'Or': 2, 'Xor': 2, 'Unot': 2,
    'Times': 5, 'Divide': 5, 'Mod': 5,
    'Eq': 1, 'NotEq': 1, 'Lt': 1, 'Gt': 1,
    'Sll': 1, 'Srl': 1, 'Branch': 3
}
```

## 7. 输出报告格式

### 7.1 拆分统计
- 总模块数量
- 线性模块数量及比例
- 非线性模块数量及比例
- 平均模块复杂度

### 7.2 性能指标
- 总体线性化程度
- 关键路径延迟变化
- 面积估算结果
- 误差分析结果

### 7.3 可视化输出
- 模块依赖关系图
- 复杂度分布图
- 线性化程度趋势图
- 性能指标对比图